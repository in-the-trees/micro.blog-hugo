{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "Jade's microblog (all posts)",
  "icon": "{{ .Site.BaseURL }}avatar.png",
  "home_page_url": "{{ .Site.BaseURL }}microblog/",
  "feed_url": "{{ .Site.BaseURL }}api/all.json",
  "authors" : [
    {
      "url" : "{{ .Site.BaseURL }}",
      "name" : "Jade van Dorsten"
    }
  ],
  "language": "en",
  "items": [
    {{- $allPosts := where .Site.Pages "Type" "post" -}}
    {{- $sortedPosts := sort $allPosts ".Params.date" "desc" -}}
    {{- $list := slice -}}

    {{- range $sortedPosts -}}
        {{- $lastMod := .Lastmod.Unix -}}
        {{- $date := .Date.Unix -}}
        {{- $showUpdate := in .Params.categories "show_updated" -}}

        {{- if and $showUpdate (gt $lastMod $date) -}}
            {{- $list = $list | append (dict "post" . "date" $lastMod) -}}
        {{- else -}}
            {{- $list = $list | append (dict "post" . "date" $date) -}}
        {{- end -}}
    {{- end -}}

    {{- $list = sort $list "date" "desc" -}}
    {{- $len := len $list -}}
    {{- range $index, $value := $list -}}
        {{- $post := .post -}}
        {{- if not $post.Title -}}
            {
                {{- if $post.Params.guid -}}
                "id": "{{ $post.Params.guid }}",
                {{- else -}}
                "id": "{{ $post.Permalink }}",
                {{- end -}}
                {{- $s := $post.Content | jsonify -}}
                {{- $s := replace $s "\\u003c" "<" -}}
                {{- $s := replace $s "\\u003e" ">" -}}
                {{- $s := replace $s "\\u0026" "&" -}}
                {{- $s := replaceRE "<svg.*?</svg>" "" $s -}}
                "content_html": {{ $s }},
                {{- $date := $post.Date.Format "2006-01-02T15:04:05Z0700" -}}
                {{- $lastmod := $post.Lastmod.Format "2006-01-02T15:04:05Z0700" -}}
                "date_published": "{{ $date }}",
                {{- if in $post.Params.categories "show_updated" -}}
                "date_modified": "{{ $lastmod }}",
                {{- end -}}
                "categories": {{ $post.Params.categories | jsonify }},
                "url": "{{ $post.Permalink }}"
            }
            {{- if ne (add $index 1) $len -}},{{- end -}}
        {{- end -}}
    {{- end -}}
]

}
